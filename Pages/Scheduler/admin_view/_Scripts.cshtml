<script>
// Mini Calendar functionality
let miniCurrentDate = new Date();
let miniSelectedDate = null;

function generateMiniCalendar() {
    const year = miniCurrentDate.getFullYear();
    const month = miniCurrentDate.getMonth();
    
    // Update month/year display
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    const monthYearElement = document.getElementById('mini-calendar-month-year');
    if (monthYearElement) {
        monthYearElement.textContent = `${monthNames[month]} ${year}`;
    }
    
    // Clear previous days
    const daysContainer = document.getElementById('mini-calendar-days');
    if (!daysContainer) return;
    
    daysContainer.innerHTML = '';
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    
    // Add previous month's trailing days
    for (let i = firstDay - 1; i >= 0; i--) {
        const dayElement = createMiniDayElement(daysInPrevMonth - i, true);
        daysContainer.appendChild(dayElement);
    }
    
    // Add current month's days
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = createMiniDayElement(day, false);
        daysContainer.appendChild(dayElement);
    }
    
    // Add next month's leading days
    const totalCells = daysContainer.children.length;
    const remainingCells = 42 - totalCells; // 6 rows × 7 days
    for (let day = 1; day <= remainingCells; day++) {
        const dayElement = createMiniDayElement(day, true);
        daysContainer.appendChild(dayElement);
    }
}

function createMiniDayElement(day, isOtherMonth) {
    const dayElement = document.createElement('div');
    dayElement.className = 'mini-calendar-day';
    
    if (isOtherMonth) {
        dayElement.classList.add('other-month');
        dayElement.textContent = day;
    } else {
        const date = new Date(miniCurrentDate.getFullYear(), miniCurrentDate.getMonth(), day);
        const today = new Date();
        const dayOfWeek = date.getDay();
        
        // Add weekday highlight for Sunday (0) through Thursday (4)
        if (dayOfWeek >= 0 && dayOfWeek <= 4) {
            dayElement.classList.add('weekday-highlight');
        }
        
        // Check if this is today
        if (date.toDateString() === today.toDateString()) {
            dayElement.classList.add('today');
        }
        
        // Check if this is the selected date
        if (miniSelectedDate && date.getDate() === miniSelectedDate.getDate() && 
            date.getMonth() === miniSelectedDate.getMonth() && 
            date.getFullYear() === miniSelectedDate.getFullYear()) {
            dayElement.classList.add('selected');
        }
        
        dayElement.textContent = day;
        dayElement.onclick = () => selectMiniDate(date);
    }
    
    return dayElement;
}

function selectMiniDate(date) {
    miniSelectedDate = date;
    generateMiniCalendar();
}

function previousMonthMini() {
    miniCurrentDate.setMonth(miniCurrentDate.getMonth() - 1);
    generateMiniCalendar();
}

function nextMonthMini() {
    miniCurrentDate.setMonth(miniCurrentDate.getMonth() + 1);
    generateMiniCalendar();
}

// Mobile sidebar functionality
function toggleMobileSidebar() {
    const sidebar = document.querySelector('.mobile-sidebar');
    const overlay = document.querySelector('.mobile-sidebar-overlay');
    
    if (sidebar && overlay) {
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
    }
}

function closeMobileSidebar() {
    const sidebar = document.querySelector('.mobile-sidebar');
    const overlay = document.querySelector('.mobile-sidebar-overlay');
    
    if (sidebar && overlay) {
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set initial selected date to today
    miniSelectedDate = new Date();
    generateMiniCalendar();
    
    // Initialize main calendar if it exists
    if (document.querySelector('.calendar-grid')) {
        mainCurrentDate = new Date();
        generateMainCalendar();
    }
    
    // Close mobile sidebar when overlay is clicked
    const overlay = document.querySelector('.mobile-sidebar-overlay');
    if (overlay) {
        overlay.addEventListener('click', closeMobileSidebar);
    }

    // Navigate to Categories when the corresponding sidebar item is clicked (desktop and mobile)
    const categorySelectors = ['.sidebar-nav .sidebar-nav-item', '.mobile-sidebar-nav .mobile-sidebar-nav-item'];
    const items = document.querySelectorAll(categorySelectors.join(', '));
    items.forEach((el) => {
        if (el.textContent && el.textContent.trim().toLowerCase() === 'categories') {
            el.addEventListener('click', function () {
                window.location.href = '/scheduler/admin_view/categories';
            });
        }
    });

    // Navigate to Form Questions when the corresponding sidebar item is clicked (desktop and mobile)
    const fqItems = document.querySelectorAll(categorySelectors.join(', '));
    fqItems.forEach((el) => {
        if (el.textContent && el.textContent.trim().toLowerCase() === 'form questions') {
            el.addEventListener('click', function () {
                window.location.href = '/scheduler/admin_view/formquestions';
            });
        }
    });

    // Navigate to Payment Integrations when the corresponding sidebar item is clicked (desktop and mobile)
    const piItems = document.querySelectorAll(categorySelectors.join(', '));
    piItems.forEach((el) => {
        if (el.textContent && el.textContent.trim().toLowerCase() === 'payment integrations') {
            el.addEventListener('click', function () {
                window.location.href = '/scheduler/admin_view/paymentintegrations';
            });
        }
    });
});

// Main Calendar Variables
let mainCurrentDate = new Date();
let mainSelectedDate = null;

// Date Hours Modal Functions
function openDateModal(element) {
    const dateStr = element.getAttribute('data-date');
    const dayOfWeek = element.getAttribute('data-day');
    
    if (!dateStr || !dayOfWeek) return;
    
    // Remove previous selected state
    document.querySelectorAll('.calendar-grid .calendar-day').forEach(day => {
        day.classList.remove('selected');
    });
    
    // Add selected state to clicked element
    element.classList.add('selected');
    
    // Parse the date
    const date = new Date(dateStr + 'T00:00:00');
    mainSelectedDate = date;
    
    // Format date for display (e.g., "December 19")
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    const formattedDate = `${monthNames[date.getMonth()]} ${date.getDate()}`;
    
    // Update modal content
    document.getElementById('modalDateDisplay').textContent = formattedDate;
    document.getElementById('modalDayOfWeek').textContent = dayOfWeek;
    document.getElementById('modalEndDateInput').value = dateStr;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('dateHoursModal'));
    modal.show();
}

// Main Calendar Navigation
function previousMonthMain() {
    mainCurrentDate.setMonth(mainCurrentDate.getMonth() - 1);
    generateMainCalendar();
}

function nextMonthMain() {
    mainCurrentDate.setMonth(mainCurrentDate.getMonth() + 1);
    generateMainCalendar();
}

function generateMainCalendar() {
    const year = mainCurrentDate.getFullYear();
    const month = mainCurrentDate.getMonth();
    
    // Update month/year display
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    const monthYearElement = document.getElementById('mainCalendarMonthYear');
    if (monthYearElement) {
        monthYearElement.textContent = `${monthNames[month]} ${year}`;
    }
    
    // Get the calendar grid
    const calendarGrid = document.querySelector('.calendar-grid');
    if (!calendarGrid) return;
    
    // Clear existing days (keep weekday headers)
    const weekdayHeaders = Array.from(calendarGrid.querySelectorAll('.calendar-weekday'));
    calendarGrid.innerHTML = '';
    weekdayHeaders.forEach(header => calendarGrid.appendChild(header));
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    
    // Add previous month's trailing days
    for (let i = firstDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        const prevMonth = month === 0 ? 11 : month - 1;
        const prevYear = month === 0 ? year - 1 : year;
        const dayElement = createMainDayElement(day, prevMonth, prevYear, true);
        calendarGrid.appendChild(dayElement);
    }
    
    // Add current month's days
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = createMainDayElement(day, month, year, false);
        calendarGrid.appendChild(dayElement);
    }
    
    // Add next month's leading days
    const totalCells = calendarGrid.children.length - 7; // Subtract weekday headers
    const remainingCells = 35 - totalCells; // 5 rows × 7 days
    for (let day = 1; day <= remainingCells; day++) {
        const nextMonth = month === 11 ? 0 : month + 1;
        const nextYear = month === 11 ? year + 1 : year;
        const dayElement = createMainDayElement(day, nextMonth, nextYear, true);
        calendarGrid.appendChild(dayElement);
    }
}

function createMainDayElement(day, month, year, isOtherMonth) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    
    const date = new Date(year, month, day);
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const dayOfWeek = dayNames[date.getDay()];
    
    dayElement.setAttribute('data-date', dateStr);
    dayElement.setAttribute('data-day', dayOfWeek);
    dayElement.setAttribute('onclick', 'openDateModal(this)');
    
    if (isOtherMonth) {
        dayElement.classList.add('other-month');
    }
    
    // Check if this is the selected date
    if (mainSelectedDate && 
        date.getDate() === mainSelectedDate.getDate() && 
        date.getMonth() === mainSelectedDate.getMonth() && 
        date.getFullYear() === mainSelectedDate.getFullYear()) {
        dayElement.classList.add('selected');
    }
    
    const dayNumber = document.createElement('div');
    dayNumber.className = 'day-number';
    dayNumber.textContent = day;
    dayElement.appendChild(dayNumber);
    
    // TODO: Add event data if available
    // For now, we'll keep the static events on Tuesdays as example
    if (date.getDay() === 2 && !isOtherMonth && day % 7 === 2) {
        dayElement.classList.add('has-event');
        const eventsList = document.createElement('div');
        eventsList.className = 'day-events-list';
        eventsList.innerHTML = `
            <div class="day-event">9:00 - 11:00 AM</div>
            <div class="day-event">Break 1</div>
            <div class="day-event">1:00 - 5:00 PM</div>
        `;
        dayElement.appendChild(eventsList);
    }
    
    return dayElement;
}

function addTimeSlot() {
    const container = document.getElementById('timeSlotContainer');
    
    // Create new time slot
    const newSlot = document.createElement('div');
    newSlot.className = 'time-slot-row';
    newSlot.innerHTML = `
        <div class="time-input-wrapper">
            <label class="time-label-small">From</label>
            <input type="time" class="form-control time-input-small" />
        </div>
        <div class="time-input-wrapper">
            <label class="time-label-small">To</label>
            <input type="time" class="form-control time-input-small" />
        </div>
    `;
    
    container.appendChild(newSlot);
}

// Categories Page - New Category Form Functions
document.addEventListener('DOMContentLoaded', function() {
    const btnNewCategory = document.getElementById('btnNewCategory');
    const btnBackToCategories = document.getElementById('btnBackToCategories');
    const btnCancelCategory = document.getElementById('btnCancelCategory');
    const btnAddSubCategory = document.getElementById('btnAddSubCategory');
    const newCategoryForm = document.getElementById('newCategoryForm');
    const categoriesHeader = document.getElementById('categoriesHeader');
    const categoriesList = document.getElementById('categoriesList');
    
    let subCategoryCount = 2; // We start with 2 sub-categories
    
    // Show new category form
    if (btnNewCategory) {
        btnNewCategory.addEventListener('click', function(e) {
            e.preventDefault();
            categoriesHeader.style.display = 'none';
            categoriesList.style.display = 'none';
            newCategoryForm.style.display = 'block';
        });
    }
    
    // Go back to categories list
    if (btnBackToCategories) {
        btnBackToCategories.addEventListener('click', function(e) {
            e.preventDefault();
            newCategoryForm.style.display = 'none';
            categoriesHeader.style.display = 'flex';
            categoriesList.style.display = 'block';
        });
    }
    
    // Cancel button
    if (btnCancelCategory) {
        btnCancelCategory.addEventListener('click', function(e) {
            e.preventDefault();
            newCategoryForm.style.display = 'none';
            categoriesHeader.style.display = 'flex';
            categoriesList.style.display = 'block';
        });
    }
    
    // Add new sub-category
    if (btnAddSubCategory) {
        btnAddSubCategory.addEventListener('click', function(e) {
            e.preventDefault();
            subCategoryCount++;
            
            const subCategoriesContainer = document.getElementById('subCategoriesContainer');
            const newSubCategory = document.createElement('div');
            newSubCategory.className = 'sub-category-section';
            newSubCategory.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label mb-0" style="font-size: 14px; color: #333;">Sub-Category ${subCategoryCount}</label>
                    <a href="#" class="delete-subcategory" style="font-size: 14px; text-decoration: none;">Delete</a>
                </div>
                <input type="text" class="form-control mb-3" placeholder="Enter Name" style="max-width: 100%;" />
                
                <p class="form-text text-muted small mb-2" style="font-size: 13px;">Select the appointments included in this sub-category</p>
                <div class="category-checkboxes-container">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sub${subCategoryCount}_hotOil">
                        <label class="form-check-label" for="sub${subCategoryCount}_hotOil">Hot Oil</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sub${subCategoryCount}_eyebrow">
                        <label class="form-check-label" for="sub${subCategoryCount}_eyebrow">Eyebrow Threading</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sub${subCategoryCount}_eyebrow2">
                        <label class="form-check-label" for="sub${subCategoryCount}_eyebrow2">Eyebrow Lift</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sub${subCategoryCount}_manicure">
                        <label class="form-check-label" for="sub${subCategoryCount}_manicure">Manicure</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sub${subCategoryCount}_pedicure">
                        <label class="form-check-label" for="sub${subCategoryCount}_pedicure">Pedicure</label>
                    </div>
                </div>
            `;
            
            subCategoriesContainer.appendChild(newSubCategory);
            
            // Attach delete handler to the new sub-category
            attachDeleteHandler(newSubCategory.querySelector('.delete-subcategory'));
        });
    }
    
    // Delete sub-category handler
    function attachDeleteHandler(deleteButton) {
        if (deleteButton) {
            deleteButton.addEventListener('click', function(e) {
                e.preventDefault();
                const subCategorySection = this.closest('.sub-category-section');
                if (subCategorySection) {
                    subCategorySection.remove();
                    // Renumber remaining sub-categories
                    renumberSubCategories();
                }
            });
        }
    }
    
    // Renumber sub-categories after deletion
    function renumberSubCategories() {
        const subCategories = document.querySelectorAll('.sub-category-section');
        subCategories.forEach((section, index) => {
            const label = section.querySelector('.form-label');
            if (label) {
                label.textContent = `Sub-Category ${index + 1}`;
            }
        });
        subCategoryCount = subCategories.length;
    }
    
    // Attach delete handlers to existing sub-categories
    document.querySelectorAll('.delete-subcategory').forEach(attachDeleteHandler);
    
    // Handle form submission
    const categoryForm = document.getElementById('categoryForm');
    if (categoryForm) {
        categoryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            // Here you would typically send the form data to the server
            alert('Category saved successfully!');
            // Go back to categories list
            newCategoryForm.style.display = 'none';
            categoriesHeader.style.display = 'flex';
            categoriesList.style.display = 'block';
        });
    }
});
</script>
