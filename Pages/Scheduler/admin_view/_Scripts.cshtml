<script>
// Mini Calendar functionality
let miniCurrentDate = new Date();
let miniSelectedDate = null;

function generateMiniCalendar() {
    const year = miniCurrentDate.getFullYear();
    const month = miniCurrentDate.getMonth();
    
    // Update month/year display
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    const monthYearElement = document.getElementById('mini-calendar-month-year');
    if (monthYearElement) {
        monthYearElement.textContent = `${monthNames[month]} ${year}`;
    }
    
    // Clear previous days
    const daysContainer = document.getElementById('mini-calendar-days');
    if (!daysContainer) return;
    
    daysContainer.innerHTML = '';
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    
    // Add previous month's trailing days
    for (let i = firstDay - 1; i >= 0; i--) {
        const dayElement = createMiniDayElement(daysInPrevMonth - i, true);
        daysContainer.appendChild(dayElement);
    }
    
    // Add current month's days
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = createMiniDayElement(day, false);
        daysContainer.appendChild(dayElement);
    }
    
    // Add next month's leading days
    const totalCells = daysContainer.children.length;
    const remainingCells = 42 - totalCells; // 6 rows × 7 days
    for (let day = 1; day <= remainingCells; day++) {
        const dayElement = createMiniDayElement(day, true);
        daysContainer.appendChild(dayElement);
    }
}

function createMiniDayElement(day, isOtherMonth) {
    const dayElement = document.createElement('div');
    dayElement.className = 'mini-calendar-day';
    
    if (isOtherMonth) {
        dayElement.classList.add('other-month');
        dayElement.textContent = day;
    } else {
        const date = new Date(miniCurrentDate.getFullYear(), miniCurrentDate.getMonth(), day);
        const today = new Date();
        const dayOfWeek = date.getDay();
        
        // Add weekday highlight for Sunday (0) through Thursday (4)
        if (dayOfWeek >= 0 && dayOfWeek <= 4) {
            dayElement.classList.add('weekday-highlight');
        }
        
        // Check if this is today
        if (date.toDateString() === today.toDateString()) {
            dayElement.classList.add('today');
        }
        
        // Check if this is the selected date
        if (miniSelectedDate && date.getDate() === miniSelectedDate.getDate() && 
            date.getMonth() === miniSelectedDate.getMonth() && 
            date.getFullYear() === miniSelectedDate.getFullYear()) {
            dayElement.classList.add('selected');
        }
        
        dayElement.textContent = day;
        dayElement.onclick = () => selectMiniDate(date);
    }
    
    return dayElement;
}

function selectMiniDate(date) {
    miniSelectedDate = date;
    generateMiniCalendar();
}

function previousMonthMini() {
    miniCurrentDate.setMonth(miniCurrentDate.getMonth() - 1);
    generateMiniCalendar();
}

function nextMonthMini() {
    miniCurrentDate.setMonth(miniCurrentDate.getMonth() + 1);
    generateMiniCalendar();
}

// Mobile sidebar functionality
function toggleMobileSidebar() {
    const sidebar = document.querySelector('.mobile-sidebar');
    const overlay = document.querySelector('.mobile-sidebar-overlay');
    
    if (sidebar && overlay) {
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
    }
}

function closeMobileSidebar() {
    const sidebar = document.querySelector('.mobile-sidebar');
    const overlay = document.querySelector('.mobile-sidebar-overlay');
    
    if (sidebar && overlay) {
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set initial selected date to today
    miniSelectedDate = new Date();
    generateMiniCalendar();
    
    // Initialize main calendar if it exists
    if (document.querySelector('.calendar-grid')) {
        mainCurrentDate = new Date();
        generateMainCalendar();
    }
    
    // Close mobile sidebar when overlay is clicked
    const overlay = document.querySelector('.mobile-sidebar-overlay');
    if (overlay) {
        overlay.addEventListener('click', closeMobileSidebar);
    }

    // Navigate to Categories when the corresponding sidebar item is clicked (desktop and mobile)
    const categorySelectors = ['.sidebar-nav .sidebar-nav-item', '.mobile-sidebar-nav .mobile-sidebar-nav-item'];
    const items = document.querySelectorAll(categorySelectors.join(', '));
    items.forEach((el) => {
        if (el.textContent && el.textContent.trim().toLowerCase() === 'categories') {
            el.addEventListener('click', function () {
                window.location.href = '/scheduler/admin_view/categories';
            });
        }
    });

    // Navigate to Form Questions when the corresponding sidebar item is clicked (desktop and mobile)
    const fqItems = document.querySelectorAll(categorySelectors.join(', '));
    fqItems.forEach((el) => {
        if (el.textContent && el.textContent.trim().toLowerCase() === 'form questions') {
            el.addEventListener('click', function () {
                window.location.href = '/scheduler/admin_view/formquestions';
            });
        }
    });

    // Navigate to Payment Integrations when the corresponding sidebar item is clicked (desktop and mobile)
    const piItems = document.querySelectorAll(categorySelectors.join(', '));
    piItems.forEach((el) => {
        if (el.textContent && el.textContent.trim().toLowerCase() === 'payment integrations') {
            el.addEventListener('click', function () {
                window.location.href = '/scheduler/admin_view/paymentintegrations';
            });
        }
    });
});

// Main Calendar Variables
let mainCurrentDate = new Date();
let mainSelectedDate = null;

// Date Hours Modal Functions
function openDateModal(element) {
    const dateStr = element.getAttribute('data-date');
    const dayOfWeek = element.getAttribute('data-day');
    
    if (!dateStr || !dayOfWeek) return;
    
    // Remove previous selected state
    document.querySelectorAll('.calendar-grid .calendar-day').forEach(day => {
        day.classList.remove('selected');
    });
    
    // Add selected state to clicked element
    element.classList.add('selected');
    
    // Parse the date
    const date = new Date(dateStr + 'T00:00:00');
    mainSelectedDate = date;
    
    // Format date for display (e.g., "December 19")
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    const formattedDate = `${monthNames[date.getMonth()]} ${date.getDate()}`;
    
    // Update modal content
    document.getElementById('modalDateDisplay').textContent = formattedDate;
    document.getElementById('modalDayOfWeek').textContent = dayOfWeek;
    document.getElementById('modalEndDateInput').value = dateStr;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('dateHoursModal'));
    modal.show();
}

// Main Calendar Navigation
function previousMonthMain() {
    mainCurrentDate.setMonth(mainCurrentDate.getMonth() - 1);
    generateMainCalendar();
}

function nextMonthMain() {
    mainCurrentDate.setMonth(mainCurrentDate.getMonth() + 1);
    generateMainCalendar();
}

function generateMainCalendar() {
    const year = mainCurrentDate.getFullYear();
    const month = mainCurrentDate.getMonth();
    
    // Update month/year display
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    const monthYearElement = document.getElementById('mainCalendarMonthYear');
    if (monthYearElement) {
        monthYearElement.textContent = `${monthNames[month]} ${year}`;
    }
    
    // Get the calendar grid
    const calendarGrid = document.querySelector('.calendar-grid');
    if (!calendarGrid) return;
    
    // Clear existing days (keep weekday headers)
    const weekdayHeaders = Array.from(calendarGrid.querySelectorAll('.calendar-weekday'));
    calendarGrid.innerHTML = '';
    weekdayHeaders.forEach(header => calendarGrid.appendChild(header));
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    
    // Add previous month's trailing days
    for (let i = firstDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        const prevMonth = month === 0 ? 11 : month - 1;
        const prevYear = month === 0 ? year - 1 : year;
        const dayElement = createMainDayElement(day, prevMonth, prevYear, true);
        calendarGrid.appendChild(dayElement);
    }
    
    // Add current month's days
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = createMainDayElement(day, month, year, false);
        calendarGrid.appendChild(dayElement);
    }
    
    // Add next month's leading days
    const totalCells = calendarGrid.children.length - 7; // Subtract weekday headers
    const remainingCells = 35 - totalCells; // 5 rows × 7 days
    for (let day = 1; day <= remainingCells; day++) {
        const nextMonth = month === 11 ? 0 : month + 1;
        const nextYear = month === 11 ? year + 1 : year;
        const dayElement = createMainDayElement(day, nextMonth, nextYear, true);
        calendarGrid.appendChild(dayElement);
    }
}

function createMainDayElement(day, month, year, isOtherMonth) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    
    const date = new Date(year, month, day);
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const dayOfWeek = dayNames[date.getDay()];
    
    dayElement.setAttribute('data-date', dateStr);
    dayElement.setAttribute('data-day', dayOfWeek);
    dayElement.setAttribute('onclick', 'openDateModal(this)');
    
    if (isOtherMonth) {
        dayElement.classList.add('other-month');
    }
    
    // Check if this is the selected date
    if (mainSelectedDate && 
        date.getDate() === mainSelectedDate.getDate() && 
        date.getMonth() === mainSelectedDate.getMonth() && 
        date.getFullYear() === mainSelectedDate.getFullYear()) {
        dayElement.classList.add('selected');
    }
    
    const dayNumber = document.createElement('div');
    dayNumber.className = 'day-number';
    dayNumber.textContent = day;
    dayElement.appendChild(dayNumber);
    
    // TODO: Add event data if available
    // For now, we'll keep the static events on Tuesdays as example
    if (date.getDay() === 2 && !isOtherMonth && day % 7 === 2) {
        dayElement.classList.add('has-event');
        const eventsList = document.createElement('div');
        eventsList.className = 'day-events-list';
        eventsList.innerHTML = `
            <div class="day-event">9:00 - 11:00 AM</div>
            <div class="day-event">Break 1</div>
            <div class="day-event">1:00 - 5:00 PM</div>
        `;
        dayElement.appendChild(eventsList);
    }
    
    return dayElement;
}

function addTimeSlot() {
    const container = document.getElementById('timeSlotContainer');
    
    // Create new time slot
    const newSlot = document.createElement('div');
    newSlot.className = 'time-slot-row';
    newSlot.innerHTML = `
        <div class="time-input-wrapper">
            <label class="time-label-small">From</label>
            <input type="time" class="form-control time-input-small" />
        </div>
        <div class="time-input-wrapper">
            <label class="time-label-small">To</label>
            <input type="time" class="form-control time-input-small" />
        </div>
        <button type="button" class="btn btn-delete-row" onclick="deleteTimeSlotRow(this)">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M2.5 5H4.16667H17.5" stroke="#ff5400" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M6.66667 5V3.33333C6.66667 2.89131 6.84226 2.46738 7.15482 2.15482C7.46738 1.84226 7.89131 1.66667 8.33333 1.66667H11.6667C12.1087 1.66667 12.5326 1.84226 12.8452 2.15482C13.1577 2.46738 13.3333 2.89131 13.3333 3.33333V5M15.8333 5V16.6667C15.8333 17.1087 15.6577 17.5326 15.3452 17.8452C15.0326 18.1577 14.6087 18.3333 14.1667 18.3333H5.83333C5.39131 18.3333 4.96738 18.1577 4.65482 17.8452C4.34226 17.5326 4.16667 17.1087 4.16667 16.6667V5H15.8333Z" stroke="#ff5400" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8.33333 9.16667V14.1667" stroke="#ff5400" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M11.6667 9.16667V14.1667" stroke="#ff5400" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    `;
    
    container.appendChild(newSlot);
}

// Delete row functions for modals
function deleteTimeRow(button) {
    const row = button.closest('.time-row-modal');
    if (row) {
        row.remove();
    }
}

function deleteTimeSlotRow(button) {
    const row = button.closest('.time-slot-row');
    if (row) {
        row.remove();
    }
}

function deleteBlockTimeRow(button) {
    // For Block Off Time modal - delete the label and time row together
    const timeRow = button.closest('.time-row-modal');
    if (timeRow) {
        // Find the preceding label div (sibling before the time row)
        const prevSibling = timeRow.previousElementSibling;
        if (prevSibling && prevSibling.querySelector('.block-label-modal')) {
            prevSibling.remove();
        }
        timeRow.remove();
    }
}

function deleteBlockDayRow(button) {
    // For Block Off Day modal - delete the label and date row together
    const dateRow = button.closest('.time-row-modal');
    if (dateRow) {
        // Find the preceding label div (sibling before the date row)
        const prevSibling = dateRow.previousElementSibling;
        if (prevSibling && prevSibling.querySelector('.block-label-modal')) {
            prevSibling.remove();
        }
        dateRow.remove();
    }
}

// Add row functions for modals
function addSetTimeRow() {
    const modal = document.querySelector('#setTimeModal .modal-body');
    const addButton = modal.querySelector('.btn-add-time-modal');
    
    const newRow = document.createElement('div');
    newRow.className = 'time-row-modal mb-3';
    newRow.innerHTML = `
        <div class="time-input-group">
            <label class="time-label-modal">From</label>
            <input type="time" class="form-control time-control-modal" />
        </div>
        <div class="time-input-group">
            <label class="time-label-modal">To</label>
            <input type="time" class="form-control time-control-modal" />
        </div>
        <button type="button" class="btn btn-delete-row" onclick="deleteTimeRow(this)">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M2.5 5H4.16667H17.5" stroke="#ff5400" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M6.66667 5V3.33333C6.66667 2.89131 6.84226 2.46738 7.15482 2.15482C7.46738 1.84226 7.89131 1.66667 8.33333 1.66667H11.6667C12.1087 1.66667 12.5326 1.84226 12.8452 2.15482C13.1577 2.46738 13.3333 2.89131 13.3333 3.33333V5M15.8333 5V16.6667C15.8333 17.1087 15.6577 17.5326 15.3452 17.8452C15.0326 18.1577 14.6087 18.3333 14.1667 18.3333H5.83333C5.39131 18.3333 4.96738 18.1577 4.65482 17.8452C4.34226 17.5326 4.16667 17.1087 4.16667 16.6667V5H15.8333Z" stroke="#ff5400" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8.33333 9.16667V14.1667" stroke="#ff5400" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M11.6667 9.16667V14.1667" stroke="#ff5400" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    `;
    
    addButton.parentNode.insertBefore(newRow, addButton);
}

function addBlockOffTimeRow() {
    const modal = document.querySelector('#blockOffTimeModal .modal-body');
    const addButton = modal.querySelector('.btn-add-time-modal');
    
    // Create label div
    const labelDiv = document.createElement('div');
    labelDiv.innerHTML = `
        <label class="block-label-modal">Label</label>
        <input type="text" class="form-control block-input-modal" placeholder="Break" />
    `;
    
    // Create time row
    const newRow = document.createElement('div');
    newRow.className = 'time-row-modal';
    newRow.innerHTML = `
        <div class="time-input-group">
            <label class="time-label-modal">From</label>
            <input type="time" class="form-control time-control-modal" placeholder="Set Time" />
        </div>
        <div class="time-input-group">
            <label class="time-label-modal">To</label>
            <input type="time" class="form-control time-control-modal" placeholder="Set Time" />
        </div>
        <button type="button" class="btn btn-delete-row" onclick="deleteBlockTimeRow(this)">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M2.5 5H4.16667H17.5" stroke="#ff5400" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M6.66667 5V3.33333C6.66667 2.89131 6.84226 2.46738 7.15482 2.15482C7.46738 1.84226 7.89131 1.66667 8.33333 1.66667H11.6667C12.1087 1.66667 12.5326 1.84226 12.8452 2.15482C13.1577 2.46738 13.3333 2.89131 13.3333 3.33333V5M15.8333 5V16.6667C15.8333 17.1087 15.6577 17.5326 15.3452 17.8452C15.0326 18.1577 14.6087 18.3333 14.1667 18.3333H5.83333C5.39131 18.3333 4.96738 18.1577 4.65482 17.8452C4.34226 17.5326 4.16667 17.1087 4.16667 16.6667V5H15.8333Z" stroke="#ff5400" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8.33333 9.16667V14.1667" stroke="#ff5400" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M11.6667 9.16667V14.1667" stroke="#ff5400" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    `;
    
    addButton.parentNode.insertBefore(labelDiv, addButton);
    addButton.parentNode.insertBefore(newRow, addButton);
}

function addBlockOffDayRow() {
    const modal = document.querySelector('#blockOffDayModal .modal-body');
    const addButton = modal.querySelector('.btn-add-another-day');
    
    // Create label div
    const labelDiv = document.createElement('div');
    labelDiv.innerHTML = `
        <label class="block-label-modal">Label</label>
        <input type="text" class="form-control block-input-modal" placeholder="Example: Vacation, Holiday" />
    `;
    
    // Create date row
    const newRow = document.createElement('div');
    newRow.className = 'time-row-modal';
    newRow.innerHTML = `
        <div class="time-input-group">
            <label class="time-label-modal">From</label>
            <input type="date" class="form-control date-control-modal" />
        </div>
        <div class="time-input-group">
            <label class="time-label-modal">To</label>
            <input type="date" class="form-control date-control-modal" />
        </div>
        <button type="button" class="btn btn-delete-row" onclick="deleteBlockDayRow(this)">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M2.5 5H4.16667H17.5" stroke="#ff5400" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M6.66667 5V3.33333C6.66667 2.89131 6.84226 2.46738 7.15482 2.15482C7.46738 1.84226 7.89131 1.66667 8.33333 1.66667H11.6667C12.1087 1.66667 12.5326 1.84226 12.8452 2.15482C13.1577 2.46738 13.3333 2.89131 13.3333 3.33333V5M15.8333 5V16.6667C15.8333 17.1087 15.6577 17.5326 15.3452 17.8452C15.0326 18.1577 14.6087 18.3333 14.1667 18.3333H5.83333C5.39131 18.3333 4.96738 18.1577 4.65482 17.8452C4.34226 17.5326 4.16667 17.1087 4.16667 16.6667V5H15.8333Z" stroke="#ff5400" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8.33333 9.16667V14.1667" stroke="#ff5400" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M11.6667 9.16667V14.1667" stroke="#ff5400" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    `;
    
    addButton.parentNode.insertBefore(labelDiv, addButton);
    addButton.parentNode.insertBefore(newRow, addButton);
}

// Categories Page - Old code removed, now using separate NewCategory.cshtml page
</script>
